<nb-card>
    <nb-card-header>
        <div class="first-line">
            <span class="document-name">
                Tarefas ({{tasks?.length || 0}})
            </span>

            <div class="right-buttons">
                <button (click)="openTaskDialog(addOrUpdateDialog)" nbButton status="success" type="button"
                    class="form-btn">
                    Nova Tarefa
                </button>
            </div>
        </div>

        <div class="custom-search">
            <input type="text" nbInput fullWidth placeholder="Pesquisar tarefas..." (input)="filterTasks($event)">
        </div>
    </nb-card-header>

    <nb-card-body style="padding: 0 !important;">
        <table id="tasks-table">
            <tr class="tasks-table-title">
                <th *ngFor="let column of columns">{{column}}</th>
            </tr>
            <tr *ngFor="let task of filteredTasks | paginate: { itemsPerPage: 20, currentPage: p }; index as i;"
                class="tasks-table-data">
                <td>{{task?.title}}</td>
                <td>{{task?.description}}</td>
                <td>{{task?.expirationDate}}</td>
                <td>{{task?.registerDate | date:'dd/MM/yy'}}</td>
                <!-- <td class="tags"><nb-tag *ngFor="let showcase of task.showIn"
                        [text]="showcase === 'recipes' ? 'Receitas' : 'Cardápio'" status="info"></nb-tag></td> -->
                <td class="tags"><nb-tag [text]="getStatusName(task.status)" status="primary"></nb-tag></td>
                <td>{{task?.responsible.name}}</td>
                <td>
                    <button nbButton (click)="openTaskDialog(addOrUpdateDialog, task)" status="success" type="button"
                        class="form-btn" ghost>
                        <nb-icon icon="edit-outline"></nb-icon>
                    </button>
                    <button nbButton (click)="openTaskDialog(deleteDialog)" status="danger" type="button"
                        class="form-btn" ghost>
                        <nb-icon icon="trash-outline"></nb-icon>
                    </button>
                    <ng-template #deleteDialog let-data let-ref="dialogRef">
                        <nb-card class="confirm-dialog">
                            <nb-card-header>Confirmação de Exclusão</nb-card-header>
                            <nb-card-body>
                                Confirma a exclusão da tarefa {{task?.title}}? Essa ação é irreversível.
                            </nb-card-body>
                            <nb-card-footer>
                                <button (click)="ref.close()" nbButton status="danger" type="button">
                                    Cancelar
                                </button>
                                <button (click)="deleteTask(task?.id); ref.close()" nbButton status="success"
                                    type="button">
                                    Sim, excluir
                                </button>
                            </nb-card-footer>
                        </nb-card>
                    </ng-template>
                </td>
            </tr>
        </table>

        <ng-template #addOrUpdateDialog let-data let-ref="dialogRef">
            <nb-card>
                <nb-card-header>{{editing ? 'Atualizar' : 'Adicionar'}} Tarefa</nb-card-header>
                <nb-card-body>
                    <form [formGroup]="tasksForm">
                        <div class="row">
                            <input type="text" nbInput fullWidth placeholder="Título da Tarefa" formControlName="title">
                            <nb-select fullWidth placeholder="Tipo de Tarefa" formControlName="type">
                                <nb-option *ngFor="let cat of categories"
                                    [value]="cat.shortTitle">{{cat.title}}</nb-option>
                            </nb-select>
                        </div>

                        <div class="row">
                            <input type="number" nbInput fullWidth placeholder="Qtd. Porção (g)"
                                formControlName="totalPortion">
                            <input type="number" nbInput fullWidth placeholder="Valor energético (kcal)"
                                formControlName="energeticValue">
                        </div>

                        <div class="row">
                            <input type="number" nbInput fullWidth placeholder="Carboidratos totais (g)"
                                formControlName="totalCarbohydrates">
                            <input type="number" nbInput fullWidth placeholder="Açúcares totais (g)"
                                formControlName="totalSugars">
                            <input type="number" nbInput fullWidth placeholder="Açúcares adicionados (g)"
                                formControlName="addedSugars">
                        </div>

                        <div>
                            <!-- <h4>Selecione o responsável:</h4> -->
                            <input type="text" nbInput fullWidth placeholder="Selecionar o responsável..."
                                (input)="filterResponsibleList($event)">
                            <ul class="group-list">
                                <li *ngFor="let group of filteredTaskResponsibles"
                                    (click)="onTaskResponsibleChoose(group)"
                                    [ngClass]="group?.isClicked ? 'group-selected' : ''">
                                    {{ group.title }}
                                </li>
                            </ul>
                            <nb-tag-list (tagRemove)="onResponsibleRemove($event)">
                                <nb-tag *ngFor="let group of choosedTask.groups" [text]="getResponsibleTitle(group)"
                                    status="primary" [removable]="true"></nb-tag>
                            </nb-tag-list>
                        </div>

                    </form>
                </nb-card-body>

                <nb-card-footer>
                    <button (click)="ref.close(); getTasks();" nbButton status="danger" type="button">
                        Fechar
                    </button>
                    <button [disabled]="tasksForm.invalid" (click)="addOrUpdateTask(); ref.close()" nbButton
                        status="success" type="button">
                        {{editing ? 'Atualizar' : 'Adicionar'}}
                    </button>
                </nb-card-footer>
            </nb-card>
        </ng-template>

    </nb-card-body>
    <pagination-controls (pageChange)="p = $event"></pagination-controls>
</nb-card>